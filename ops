{"author":{"id":"4eafddffaee687b3dd7df26ea1d30b9ac826045444d170b9544d7a14620429e8"},"ops":[{"type":6,"timestamp":1614181115,"nonce":"4L9crgbexiJ9DfQDoh+1ifnGh9c=","metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0OTg2NzU3NjU="},"target":"3cad7d93de4d74bbb746f5aed03177bee3bd23ca4e0105ac43cfdf471ed6ebfd","message":"**Describe the bug**\nThe telemetry test suit fails on WFB due to a malformed packet in the *\"test_proxy\"* test case.\n\nTwo issues seems to be at the root of this bug : \n- The packets sent by the test case is badly handled by the [UDPProxyProtocol.write()](https://github.com/svpcom/wifibroadcast/blob/c7ea0a5ddb360cfd6243d5af14fc8a856271fd1d/telemetry/proxy.py#L87) function : \n  the function  expects to unpack a bytes-like object form the the packet array to get the mavlink version, but it gets an array of integer instead =\u003e **throws a TypeError**.\n- The [Echo.datagramReceived()](https://github.com/svpcom/wifibroadcast/blob/c7ea0a5ddb360cfd6243d5af14fc8a856271fd1d/telemetry/tests/test_proxy.py#L26) function echoes the data it received as a string instead of a bytes-like object.\n\n**To Reproduce**\n1. Clone the last version of WFB (at this time : svpcom/wifibroadcast@c7ea0a5)\n2. Install all the C/C++ dependencies \u0026 Python3 dependencies\n3. Build the binaries : `make all_bin`\n4. Execute the telemetry test suit : `make test`\n \n**Expected behavior**\n- [Echo.datagramReceived()](https://github.com/svpcom/wifibroadcast/blob/c7ea0a5ddb360cfd6243d5af14fc8a856271fd1d/telemetry/tests/test_proxy.py#L26) function should only write bytes-like data.\n\n**Screenshots**\n```bash\n2021-02-24 14:56:45+0100 [-] Log opened.\n2021-02-24 14:56:45+0100 [-] --\u003e telemetry.tests.test_proxy.UDPProxyTestCase.test_proxy \u003c--\n2021-02-24 14:56:45+0100 [-] UDPProxyProtocol starting on 14551\n2021-02-24 14:56:45+0100 [-] UDPProxyProtocol starting on 43907\n2021-02-24 14:56:45+0100 [-] SendPacket starting on 9999\n2021-02-24 14:56:45+0100 [-] Starting protocol \u003ctelemetry.tests.test_proxy.SendPacket object at 0x7f41996dd1c0\u003e\n2021-02-24 14:56:45+0100 [-] send 10 of b'test' to ('127.0.0.1', 14551)\n2021-02-24 14:56:45+0100 [-] Echo starting on 14553\n2021-02-24 14:56:45+0100 [-] Starting protocol \u003ctelemetry.tests.test_proxy.Echo object at 0x7f41996dd220\u003e\n2021-02-24 14:56:46+0100 [Echo (UDP)] got 'testtesttesttesttesttesttesttesttesttest' from ('127.0.0.1', 43907)\n2021-02-24 14:56:46+0100 [UDPProxyProtocol (UDP)] msg data (raw) : 116\n2021-02-24 14:56:46+0100 [UDPProxyProtocol (UDP)] msg data (char) : t\n2021-02-24 14:56:46+0100 [UDPProxyProtocol (UDP)] Unhandled Error\n\tTraceback (most recent call last):\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/python/log.py\", line 86, in callWithContext\n\t    return context.call({ILogContext: newCtx}, func, *args, **kw)\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/python/context.py\", line 122, in callWithContext\n\t    return self.currentContext().callWithContext(ctx, func, *args, **kw)\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/python/context.py\", line 85, in callWithContext\n\t    return func(*args,**kw)\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/internet/posixbase.py\", line 614, in _doReadOrWrite\n\t    why = selectable.doRead()\n\t--- \u003cexception caught here\u003e ---\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/internet/udp.py\", line 249, in doRead\n\t    self.protocol.datagramReceived(data, addr)\n\t  File \"/home/lucasgrelaud/Dev/UAV/wifibroadcast/telemetry/proxy.py\", line 125, in datagramReceived\n\t    return self._send_to_peer(data)\n\t  File \"/home/lucasgrelaud/Dev/UAV/wifibroadcast/telemetry/proxy.py\", line 115, in _send_to_peer\n\t    self.peer.write(data)\n\t  File \"/home/lucasgrelaud/Dev/UAV/wifibroadcast/telemetry/proxy.py\", line 87, in write\n\t    version = struct.unpack('B', msg[i])[0]\n\tbuiltins.TypeError: a bytes-like object is required, not 'int'\n\t\n2021-02-24 14:58:45+0100 [-] Main loop terminated.\n2021-02-24 14:58:45+0100 [-] (UDP Port 14551 Closed)\n2021-02-24 14:58:45+0100 [-] (UDP Port 43907 Closed)\n2021-02-24 14:58:45+0100 [-] --\u003e telemetry.tests.test_proxy.UDPProxyTestCase.test_rssi_injection \u003c--\n2021-02-24 14:58:45+0100 [-] UDPProxyProtocol starting on 14551\n2021-02-24 14:58:45+0100 [-] UDPProxyProtocol starting on 56163\n2021-02-24 14:58:45+0100 [-] (UDP Port 14551 Closed)\n2021-02-24 14:58:45+0100 [-] (UDP Port 56163 Closed)\n2021-02-24 14:58:45+0100 [-] --\u003e telemetry.tests.test_tuntap.TUNTAPTestCase.test_tuntap \u003c--\n2021-02-24 14:58:45+0100 [-] (UDP Port 14553 Closed)\n2021-02-24 14:58:45+0100 [-] Stopping protocol \u003ctelemetry.tests.test_proxy.Echo object at 0x7f41996dd220\u003e\n2021-02-24 14:58:45+0100 [-] (UDP Port 9999 Closed)\n2021-02-24 14:58:45+0100 [-] Stopping protocol \u003ctelemetry.tests.test_proxy.SendPacket object at 0x7f41996dd1c0\u003e\n2021-02-24 14:58:46+0100 [-] Main loop terminated.\n```\n\n**Your setup (please complete the following information):**\n - OS Fedora 33 Workstation with Python3.9\n - Hardware : MS Surface Pro 5 (2017)\n - WiFi cards : N.A. (virbr0 \u0026 virbr0-nic for the test suit)\n - WiFi drivers : N.A.\n\n**Additional context**\nAdd any other context about the problem here.\n\n**Confirm you read**\n- [x]  https://github.com/svpcom/wifibroadcast/blob/master/README.md\n- [x]  https://github.com/svpcom/wifibroadcast/wiki/Setup-HOWTO","files":null},{"type":6,"timestamp":1614181340,"nonce":"IM6dWOlJpC0f3xMns791S0COzfw=","metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlRWRpdDo0OTg2Nzc5NDg="},"target":"3cad7d93de4d74bbb746f5aed03177bee3bd23ca4e0105ac43cfdf471ed6ebfd","message":"**Describe the bug**\nThe telemetry test suit fails on WFB due to a malformed packet in the *\"test_proxy\"* test case.\n\nTwo issues seems to be at the root of this bug : \n- The packets sent by the test case is badly handled by the [UDPProxyProtocol.write()](https://github.com/svpcom/wifibroadcast/blob/c7ea0a5ddb360cfd6243d5af14fc8a856271fd1d/telemetry/proxy.py#L87) function : \n  the function  expects to unpack a bytes-like object form the the packet array to get the mavlink version, but it gets an array of integer instead =\u003e **throws a TypeError**.\n- The [Echo.datagramReceived()](https://github.com/svpcom/wifibroadcast/blob/c7ea0a5ddb360cfd6243d5af14fc8a856271fd1d/telemetry/tests/test_proxy.py#L26) function echoes the data it received as a string instead of a bytes-like object.\n\n**To Reproduce**\n1. Clone the last version of WFB (at this time : svpcom/wifibroadcast@c7ea0a5)\n2. Install all the C/C++ dependencies \u0026 Python3 dependencies\n3. Build the binaries : `make all_bin`\n4. Execute the telemetry test suit : `make test`\n \n**Expected behavior**\n- [UDPProxyProtocol.write()](https://github.com/svpcom/wifibroadcast/blob/c7ea0a5ddb360cfd6243d5af14fc8a856271fd1d/telemetry/proxy.py#L87) function should store the __\"msg\"__ data as an array of bytes\n\n**Screenshots**\n```bash\n2021-02-24 14:56:45+0100 [-] Log opened.\n2021-02-24 14:56:45+0100 [-] --\u003e telemetry.tests.test_proxy.UDPProxyTestCase.test_proxy \u003c--\n2021-02-24 14:56:45+0100 [-] UDPProxyProtocol starting on 14551\n2021-02-24 14:56:45+0100 [-] UDPProxyProtocol starting on 43907\n2021-02-24 14:56:45+0100 [-] SendPacket starting on 9999\n2021-02-24 14:56:45+0100 [-] Starting protocol \u003ctelemetry.tests.test_proxy.SendPacket object at 0x7f41996dd1c0\u003e\n2021-02-24 14:56:45+0100 [-] send 10 of b'test' to ('127.0.0.1', 14551)\n2021-02-24 14:56:45+0100 [-] Echo starting on 14553\n2021-02-24 14:56:45+0100 [-] Starting protocol \u003ctelemetry.tests.test_proxy.Echo object at 0x7f41996dd220\u003e\n2021-02-24 14:56:46+0100 [Echo (UDP)] got 'testtesttesttesttesttesttesttesttesttest' from ('127.0.0.1', 43907)\n2021-02-24 14:56:46+0100 [UDPProxyProtocol (UDP)] msg data (raw) : 116\n2021-02-24 14:56:46+0100 [UDPProxyProtocol (UDP)] msg data (char) : t\n2021-02-24 14:56:46+0100 [UDPProxyProtocol (UDP)] Unhandled Error\n\tTraceback (most recent call last):\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/python/log.py\", line 86, in callWithContext\n\t    return context.call({ILogContext: newCtx}, func, *args, **kw)\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/python/context.py\", line 122, in callWithContext\n\t    return self.currentContext().callWithContext(ctx, func, *args, **kw)\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/python/context.py\", line 85, in callWithContext\n\t    return func(*args,**kw)\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/internet/posixbase.py\", line 614, in _doReadOrWrite\n\t    why = selectable.doRead()\n\t--- \u003cexception caught here\u003e ---\n\t  File \"/usr/lib64/python3.9/site-packages/twisted/internet/udp.py\", line 249, in doRead\n\t    self.protocol.datagramReceived(data, addr)\n\t  File \"/home/lucasgrelaud/Dev/UAV/wifibroadcast/telemetry/proxy.py\", line 125, in datagramReceived\n\t    return self._send_to_peer(data)\n\t  File \"/home/lucasgrelaud/Dev/UAV/wifibroadcast/telemetry/proxy.py\", line 115, in _send_to_peer\n\t    self.peer.write(data)\n\t  File \"/home/lucasgrelaud/Dev/UAV/wifibroadcast/telemetry/proxy.py\", line 87, in write\n\t    version = struct.unpack('B', msg[i])[0]\n\tbuiltins.TypeError: a bytes-like object is required, not 'int'\n\t\n2021-02-24 14:58:45+0100 [-] Main loop terminated.\n2021-02-24 14:58:45+0100 [-] (UDP Port 14551 Closed)\n2021-02-24 14:58:45+0100 [-] (UDP Port 43907 Closed)\n2021-02-24 14:58:45+0100 [-] --\u003e telemetry.tests.test_proxy.UDPProxyTestCase.test_rssi_injection \u003c--\n2021-02-24 14:58:45+0100 [-] UDPProxyProtocol starting on 14551\n2021-02-24 14:58:45+0100 [-] UDPProxyProtocol starting on 56163\n2021-02-24 14:58:45+0100 [-] (UDP Port 14551 Closed)\n2021-02-24 14:58:45+0100 [-] (UDP Port 56163 Closed)\n2021-02-24 14:58:45+0100 [-] --\u003e telemetry.tests.test_tuntap.TUNTAPTestCase.test_tuntap \u003c--\n2021-02-24 14:58:45+0100 [-] (UDP Port 14553 Closed)\n2021-02-24 14:58:45+0100 [-] Stopping protocol \u003ctelemetry.tests.test_proxy.Echo object at 0x7f41996dd220\u003e\n2021-02-24 14:58:45+0100 [-] (UDP Port 9999 Closed)\n2021-02-24 14:58:45+0100 [-] Stopping protocol \u003ctelemetry.tests.test_proxy.SendPacket object at 0x7f41996dd1c0\u003e\n2021-02-24 14:58:46+0100 [-] Main loop terminated.\n```\n\n**Your setup (please complete the following information):**\n - OS Fedora 33 Workstation with Python3.9\n - Hardware : MS Surface Pro 5 (2017)\n - WiFi cards : N.A. (virbr0 \u0026 virbr0-nic for the test suit)\n - WiFi drivers : N.A.\n\n**Additional context**\nAdd any other context about the problem here.\n\n**Confirm you read**\n- [x]  https://github.com/svpcom/wifibroadcast/blob/master/README.md\n- [x]  https://github.com/svpcom/wifibroadcast/wiki/Setup-HOWTO","files":null},{"type":3,"timestamp":1614329337,"nonce":"+ckGKdHvZx34nQmYHXBQZsjQzL0=","metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDc4NjUwMjM5Mw==","github-url":"https://github.com/svpcom/wfb-ng/issues/113#issuecomment-786502393"},"message":"Hi!\nThank you for your work resolving this issue!\nI'll close it :D","files":null},{"type":4,"timestamp":1614329337,"nonce":"GC690M7AgQ2CGReTBolwlapQ7JE=","metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50NDM4MDcwNzY5NA=="},"status":2}]}