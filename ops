{"author":{"id":"b03b656f2973b3294e885873225f3e6827ef890be5b6895978d995675f093aac"},"ops":[{"type":1,"timestamp":1632946273,"nonce":"/2hQozhfYfpcdhX12oGCBgk0oCs=","metadata":{"github-id":"I_kwDOBLCY8M48SL02","github-url":"https://github.com/svpcom/wfb-ng/issues/167","origin":"github"},"title":"[BUG] latency_Test.py - mixing sessions","message":"**Describe the bug**\nI tried to use {{latency_test.py}} for testing the performance of different wifi devices. For some reason I nearly always have the case, that some of the messages of one test are (obviously) received only in the next test so that I always get those \"bad session\" log messages.\nI tired to understand/debug the problem on my own but I can't find the reason.\n\n**To Reproduce**\nStart sender receiver:\n```\n\nDEV_RX=wlx00c0ca98eb12\nDEV_TX=wlx00c0ca98ebd1\n\nPARAM_N=12\nPARAM_K=8\n/usr/bin/wfb_tx -p 1 -u 14601 -K ${SCRIPT_DIR}/drone_test.key -B 20 -G long -S 0 -L 0 -M 1 -k $PARAM_K -n $PARAM_N -T 0 $DEV_TX \u0026\n/usr/bin/wfb_rx -p 1 -u 14600 -K ${SCRIPT_DIR}/gs_test.key -k $PARAM_K -n $PARAM_N $DEV_RX\n```\n\nThen I am running the tests (with some log example):\n```\npython3 latency_test.py  14601 14600 140 100\n\n\n2021-09-29 20:47:23+0100 [-] Log opened.\n2021-09-29 20:47:23+0100 [-] Session: 27269\n2021-09-29 20:47:23+0100 [-] PacketSource starting on 37622\n2021-09-29 20:47:23+0100 [-] PacketSink starting on 14600\n2021-09-29 20:47:26+0100 [-] (UDP Port 37622 Closed)\n2021-09-29 20:47:28+0100 [-] Sent 150, Lost 10, Dup: 0, Packet rate: 50 pkt/s, Bitrate: 0.06 MBit/s, Lmin 1.59 ms, Lmax 243.35 ms, Lavg 50.40 ms\n2021-09-29 20:47:28+0100 [-] (UDP Port 14600 Closed)\n2021-09-29 20:47:28+0100 [-] Session: 10452\n2021-09-29 20:47:28+0100 [-] PacketSource starting on 48290\n2021-09-29 20:47:28+0100 [-] PacketSink starting on 14600\n2021-09-29 20:47:31+0100 [-] (UDP Port 48290 Closed)\n2021-09-29 20:47:33+0100 [-] Sent 75, Lost 9, Dup: 0, Packet rate: 25 pkt/s, Bitrate: 0.03 MBit/s, Lmin 1.68 ms, Lmax 482.83 ms, Lavg 96.24 ms\n2021-09-29 20:47:33+0100 [-] (UDP Port 14600 Closed)\n2021-09-29 20:47:33+0100 [-] Session: 42351\n2021-09-29 20:47:33+0100 [-] PacketSource starting on 41888\n2021-09-29 20:47:33+0100 [-] PacketSink starting on 14600\n2021-09-29 20:47:33+0100 [PacketSink (UDP)] bad session 10452 != 42351 #69, already got 0 packets\n2021-09-29 20:47:33+0100 [PacketSink (UDP)] bad session 10452 != 42351 #70, already got 0 packets\n2021-09-29 20:47:33+0100 [PacketSink (UDP)] bad session 10452 != 42351 #71, already got 0 packets\n2021-09-29 20:47:33+0100 [PacketSink (UDP)] bad session 10452 != 42351 #72, already got 0 packets\n2021-09-29 20:47:33+0100 [PacketSink (UDP)] bad session 10452 != 42351 #74, already got 0 packets\n2021-09-29 20:47:36+0100 [-] (UDP Port 41888 Closed)\n2021-09-29 20:47:38+0100 [-] Sent 39, Lost 2, Dup: 0, Packet rate: 13 pkt/s, Bitrate: 0.01 MBit/s, Lmin 1.77 ms, Lmax 540.37 ms, Lavg 108.07 ms\n\n```\n\nAs you can see some messages with the session id of the first test (10452) are - for some reason - only received in the second test (while some messages are lost in the first test).\n\nI am testing in a very noisy environment, but I think this should no happen anyways (I also tried to increase the wait time etc).\n\nI even sometimes have the case, that I run latency_test.py several times (even with some seconds/minutes delay in between) an I get the session ID of the last execution (last test) in the next run. It even seems, as If the messages send by wfb_rx are somehow \"queued\" until some new udp socket is create and bind to it's destination port (which is completely nonsense - or I do not understand udp correctly).\nOne log as prove:\n\n```\n2021-09-29 20:47:53+0100 [-] Session: 16558\n2021-09-29 20:47:53+0100 [-] PacketSource starting on 40916\n2021-09-29 20:47:53+0100 [-] PacketSink starting on 14600\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 49519 != 16558 #9, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 49519 != 16558 #11, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 55579 != 16558 #0, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 55579 != 16558 #1, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 55579 != 16558 #2, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 55579 != 16558 #3, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 55579 != 16558 #4, already got 0 packets\n2021-09-29 20:47:53+0100 [PacketSink (UDP)] bad session 55579 != 16558 #5, already got 0 packets\n^C2021-09-29 20:47:55+0100 [-] Received SIGINT, shutting down.\n2021-09-29 20:47:55+0100 [PacketSource (UDP)] (UDP Port 40916 Closed)\n2021-09-29 20:47:55+0100 [PacketSink (UDP)] (UDP Port 14600 Closed)\n2021-09-29 20:47:55+0100 [-] Main loop terminated.\n2021-09-29 20:47:55+0100 [-] Exiting with code 0\n\n\u003c did some stuff here in between\u003e\n\npi@gcs:~/Entwicklung/wifibroadcast/telemetry $ \npi@gcs:~/Entwicklung/wifibroadcast/telemetry $ python3 latency_test.py  14601 14600 140 100\n2021-09-29 21:04:29+0100 [-] Log opened.\n2021-09-29 21:04:29+0100 [-] Session: 24177\n2021-09-29 21:04:29+0100 [-] PacketSource starting on 45784\n2021-09-29 21:04:29+0100 [-] PacketSink starting on 14600\n2021-09-29 21:04:29+0100 [PacketSink (UDP)] bad session 16558 != 24177 #3, already got 0 packets\n2021-09-29 21:04:29+0100 [PacketSink (UDP)] bad session 16558 != 24177 #4, already got 0 packets\n2021-09-29 21:04:29+0100 [PacketSink (UDP)] bad session 16558 != 24177 #5, already got 0 packets\n2021-09-29 21:04:29+0100 [PacketSink (UDP)] bad session 16558 != 24177 #6, already got 0 packets\n2021-09-29 21:04:29+0100 [PacketSink (UDP)] bad session 16558 != 24177 #7, already got 0 packets\n\u003c and so on\u003e\n```\n\n\n**Expected behavior**\nThis should not happen - all messages of one test should also get received within this test.\n\n**Your setup (please complete the following information):**\n - raspbian buster\n - current master branch of wifibroadcast\n - 2 AWUS036NHA \n\n\n**Confirm you read**\n- [ x]  https://github.com/svpcom/wifibroadcast/blob/master/README.md\n- [ x]  https://github.com/svpcom/wifibroadcast/wiki/Setup-HOWTO","files":null}]}